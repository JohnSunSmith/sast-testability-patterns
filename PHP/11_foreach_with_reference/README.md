[//]: # (This file is automatically generated. If you wish to make any changes, please use the JSON files and regenerate this file using the tpframework.)

# Foreach With Reference

Tags: sast, php, php_v7.4.9

Version: v1.0

## Description

Foreach is used by high level programming languages to iterate over arrays and objects.

```php
<?php
$arr = array(1,2,3);
foreach($arr as $value){
    echo $value;
}
```

In this example, any change on the variable $value will not change on the array $arr. If we want to keep the changes we have to add a reference.

```php
<?php
$arr = array(1,2,3);
foreach($arr as &$value){
    ...
}
```

## Overview

| Instances                 | has discovery rule   | discovery method   | rule successfull   |
|---------------------------|----------------------|--------------------|--------------------|
| [1 Instance](#1-instance) | yes                  | joern              | yes                |

## 1 Instance

This instance shows an for each loop with references.

### Code

```PHP
<?php
$arr = array("abc", "def", "ghi");
$a = $_GET["p1"];  // source
foreach ($arr as &$x) { // tarpit
// copy $a for all the elements in the array.
// the changes will be in $x and $arr in the same time.
    $x = $a;
}
// will print the value of $a, there is vulnerability
echo $arr[0]; // sink
```

### Instance Properties

| category   | feature_vs_internal_api   | input_sanitizer   | negative_test_case   | source_and_sink   |
|------------|---------------------------|-------------------|----------------------|-------------------|
| S0         | FEATURE                   | no                | no                   | no                |

<details markdown="1">
<summary>
<b>More</b></summary>

<details markdown="1">
<summary>

### Compile
</summary>

```bash
$_main:
     ; (lines=12, args=0, vars=3, tmps=7)
     ; (before optimizer)
     ; /.../PHP/11_foreach_with_reference/1_instance_11_foreach_with_reference/1_instance_11_foreach_with_reference.php:1-11
     ; return  [] RANGE[0..0]
0000 ASSIGN CV0($arr) array(...)
0001 T4 = FETCH_R (global) string("_GET")
0002 T5 = FETCH_DIM_R T4 string("p1")
0003 ASSIGN CV1($a) T5
0004 V7 = FE_RESET_RW CV0($arr) 0008
0005 FE_FETCH_RW V7 CV2($x) 0008
0006 ASSIGN CV2($x) CV1($a)
0007 JMP 0005
0008 FE_FREE V7
0009 T9 = FETCH_DIM_R CV0($arr) int(0)
0010 ECHO T9
0011 RETURN int(1)
LIVE RANGES:
     7: 0005 - 0008 (loop)
```

</details>

<details markdown="1">
<summary>

### Discovery
</summary>

```scala
val x11 = (name, "11_foreach_with_reference_iall", cpg.call(".*FE_FETCH_RW.*").location.toJson);
```

| discovery method   | expected accuracy   |
|--------------------|---------------------|
| joern              | Perfect             |

</details>

<details markdown="1"open>
<summary>

### Measurement
</summary>

| Tool        | Comm_1   | Comm_2   | phpSAFE   | Progpilot   | RIPS   | WAP   | Ground Truth   |
|-------------|----------|----------|-----------|-------------|--------|-------|----------------|
| 08 Jun 2021 | no       | no       | no        | no          | no     | no    | yes            |
| 17 May 2023 | no       | yes      |           |             |        |       | yes            |

</details>

<details markdown="1">
<summary>

### Remediation
</summary>

If possible, a copy of the array could be created and it could than be looped over the copy of that array. After the loop, the copy could be assigned back to the original array. However, is highly dependent on the content of the loop and can therefor only be done manually.

</details>

</details>
