[//]: # (This file is automatically generated. If you wish to make any changes, please use the JSON files and regenerate this file using the tpframework.)

# Procedural Queries

Tags: sast, php, php_v7.4.9

Version: v1.0

## Description

In PHP [`mysqli`](https://www.php.net/manual/en/intro.mysqli.php) and [`mysql`](https://www.php.net/manual/en/intro.mysql.php) are extensions to access MySQL databases. `mysql` is deprecated as of PHP 5.5.0. This pattern targets explicitly the usage of `query()`.

## Overview

| Instances                 | has discovery rule   | discovery method   | rule successfull   |
|---------------------------|----------------------|--------------------|--------------------|
| [1 Instance](#1-instance) | yes                  | joern              | yes                |
| [2 Instance](#2-instance) | yes                  | joern              | yes                |
| [3 Instance](#3-instance) | yes                  | joern              | yes                |

<details markdown="1"open>
<summary>

## 1 Instance
</summary>

The instance uses `mysqli` to connect and execute a select statement on a mysql database.

### Code

```PHP
<?php
$a = $_GET["p1"]; // source
$link = mysqli_connect("localhost", "my_user", "my_password", "world");
/* Create table doesn't return a resultset */
mysqli_query($link, "SELECT name, color, calories FROM $a ORDER BY name"); // sink
```

### Instance Properties

| category   | feature_vs_internal_api   | input_sanitizer   | negative_test_case   | source_and_sink   |
|------------|---------------------------|-------------------|----------------------|-------------------|
| S0         | INTERNAL_API              | no                | no                   | yes               |

<details markdown="1">
<summary>
<b>More</b></summary>

<details markdown="1">
<summary>

### Compile
</summary>

```bash
$_main:
     ; (lines=18, args=0, vars=2, tmps=9)
     ; (before optimizer)
     ; /.../PHP/72_procedural_queries/1_instance_72_procedural_queries/1_instance_72_procedural_queries.php:1-5
     ; return  [] RANGE[0..0]
0000 T2 = FETCH_R (global) string("_GET")
0001 T3 = FETCH_DIM_R T2 string("p1")
0002 ASSIGN CV0($a) T3
0003 INIT_FCALL_BY_NAME 4 string("mysqli_connect")
0004 SEND_VAL_EX string("localhost") 1
0005 SEND_VAL_EX string("my_user") 2
0006 SEND_VAL_EX string("my_password") 3
0007 SEND_VAL_EX string("world") 4
0008 V5 = DO_FCALL_BY_NAME
0009 ASSIGN CV1($link) V5
0010 INIT_FCALL_BY_NAME 2 string("mysqli_query")
0011 SEND_VAR_EX CV1($link) 1
0012 T8 = ROPE_INIT 3 string("SELECT name, color, calories FROM ")
0013 T8 = ROPE_ADD 1 T8 CV0($a)
0014 T7 = ROPE_END 2 T8 string(" ORDER BY name")
0015 SEND_VAL_EX T7 2
0016 DO_FCALL_BY_NAME
0017 RETURN int(1)
LIVE RANGES:
     8: 0012 - 0014 (rope)
```

</details>

<details markdown="1">
<summary>

### Discovery
</summary>

The rule searches for function calls to `mysqli_query` or `mysql_query` on opcode level.

```scala
val x72 = (name, "72_procedural_queries_iall", cpg.call(".*INIT_FCALL.*").argument.order(1).code("mysqli_query|mysql_query").astParent.location.toJson);
```

| discovery method   | expected accuracy   |
|--------------------|---------------------|
| joern              | Perfect             |

</details>

<details markdown="1"open>
<summary>

### Measurement
</summary>

| Tool        | Comm_1   | Comm_2   | phpSAFE   | Progpilot   | RIPS   | WAP   | Ground Truth   |
|-------------|----------|----------|-----------|-------------|--------|-------|----------------|
| 08 Jun 2021 | yes      | yes      | no        | yes         | yes    | no    | yes            |
| 22 May 2023 | yes      | no       |           |             |        |       | yes            |

</details>

</details>

</details>

<details markdown="1">
<summary>

## 2 Instance
</summary>

This instance uses `mysql` to connect and execte an sql statement. That function is deprecated, but it could still be used in older PHP applications.

### Code

```PHP
<?php
$a = $_GET["p1"]; // source
$link = mysql_connect("localhost", "my_user", "my_password", "world");
/* Create table doesn't return a resultset */
mysql_query($link, "SELECT name, color, calories FROM $a ORDER BY name"); // sink
```

### Instance Properties

| category   | feature_vs_internal_api   | input_sanitizer   | negative_test_case   | source_and_sink   |
|------------|---------------------------|-------------------|----------------------|-------------------|
| S0         | INTERNAL_API              | no                | no                   | yes               |

<details markdown="1">
<summary>
<b>More</b></summary>

<details markdown="1">
<summary>

### Compile
</summary>

```bash
$_main:
     ; (lines=18, args=0, vars=2, tmps=9)
     ; (before optimizer)
     ; /.../PHP/72_procedural_queries/2_instance_72_procedural_queries/2_instance_72_procedural_queries.php:1-5
     ; return  [] RANGE[0..0]
0000 T2 = FETCH_R (global) string("_GET")
0001 T3 = FETCH_DIM_R T2 string("p1")
0002 ASSIGN CV0($a) T3
0003 INIT_FCALL_BY_NAME 4 string("mysql_connect")
0004 SEND_VAL_EX string("localhost") 1
0005 SEND_VAL_EX string("my_user") 2
0006 SEND_VAL_EX string("my_password") 3
0007 SEND_VAL_EX string("world") 4
0008 V5 = DO_FCALL_BY_NAME
0009 ASSIGN CV1($link) V5
0010 INIT_FCALL_BY_NAME 2 string("mysql_query")
0011 SEND_VAR_EX CV1($link) 1
0012 T8 = ROPE_INIT 3 string("SELECT name, color, calories FROM ")
0013 T8 = ROPE_ADD 1 T8 CV0($a)
0014 T7 = ROPE_END 2 T8 string(" ORDER BY name")
0015 SEND_VAL_EX T7 2
0016 DO_FCALL_BY_NAME
0017 RETURN int(1)
LIVE RANGES:
     8: 0012 - 0014 (rope)
```

</details>

<details markdown="1">
<summary>

### Discovery
</summary>

The rule searches for function calls to `mysqli_query` or `mysql_query` on opcode level.

```scala
val x72 = (name, "72_procedural_queries_iall", cpg.call(".*INIT_FCALL.*").argument.order(1).code("mysqli_query|mysql_query").astParent.location.toJson);
```

| discovery method   | expected accuracy   |
|--------------------|---------------------|
| joern              | Perfect             |

</details>

<details markdown="1"open>
<summary>

### Measurement
</summary>

| Tool        | Comm_1   | Comm_2   | phpSAFE   | Progpilot   | RIPS   | WAP   | Ground Truth   |
|-------------|----------|----------|-----------|-------------|--------|-------|----------------|
| 08 Jun 2021 | yes      | yes      | no        | no          | no     | no    | yes            |
| 22 May 2023 | yes      | no       |           |             |        |       | yes            |

</details>

</details>

</details>

<details markdown="1">
<summary>

## 3 Instance
</summary>

The instance uses `mysql` for executing the sql statement. But it uses concatination for creating the sql statement.

### Code

```PHP
<?php
$a = $_GET["p1"]; // source
$link = mysql_connect("localhost", "my_user", "my_password", "world");
/* Create table doesn't return a resultset */
$sql = "SELECT name, color, calories FROM ". $a ."ORDER BY name";
mysql_query($link, $sql); // sink
```

### Instance Properties

| category   | feature_vs_internal_api   | input_sanitizer   | negative_test_case   | source_and_sink   |
|------------|---------------------------|-------------------|----------------------|-------------------|
| S0         | INTERNAL_API              | no                | no                   | yes               |

<details markdown="1">
<summary>
<b>More</b></summary>

<details markdown="1">
<summary>

### Compile
</summary>

```bash
$_main:
     ; (lines=18, args=0, vars=3, tmps=9)
     ; (before optimizer)
     ; /.../PHP/72_procedural_queries/3_instance_72_procedural_queries/3_instance_72_procedural_queries.php:1-6
     ; return  [] RANGE[0..0]
0000 T3 = FETCH_R (global) string("_GET")
0001 T4 = FETCH_DIM_R T3 string("p1")
0002 ASSIGN CV0($a) T4
0003 INIT_FCALL_BY_NAME 4 string("mysql_connect")
0004 SEND_VAL_EX string("localhost") 1
0005 SEND_VAL_EX string("my_user") 2
0006 SEND_VAL_EX string("my_password") 3
0007 SEND_VAL_EX string("world") 4
0008 V6 = DO_FCALL_BY_NAME
0009 ASSIGN CV1($link) V6
0010 T8 = CONCAT string("SELECT name, color, calories FROM ") CV0($a)
0011 T9 = CONCAT T8 string("ORDER BY name")
0012 ASSIGN CV2($sql) T9
0013 INIT_FCALL_BY_NAME 2 string("mysql_query")
0014 SEND_VAR_EX CV1($link) 1
0015 SEND_VAR_EX CV2($sql) 2
0016 DO_FCALL_BY_NAME
0017 RETURN int(1)
```

</details>

<details markdown="1">
<summary>

### Discovery
</summary>

The rule searches for function calls to `mysqli_query` or `mysql_query` on opcode level.

```scala
val x72 = (name, "72_procedural_queries_iall", cpg.call(".*INIT_FCALL.*").argument.order(1).code("mysqli_query|mysql_query").astParent.location.toJson);
```

| discovery method   | expected accuracy   |
|--------------------|---------------------|
| joern              | Perfect             |

</details>

<details markdown="1"open>
<summary>

### Measurement
</summary>

| Tool        | Comm_1   | Comm_2   | phpSAFE   | Progpilot   | RIPS   | WAP   | Ground Truth   |
|-------------|----------|----------|-----------|-------------|--------|-------|----------------|
| 08 Jun 2021 | yes      | yes      | no        | no          | no     | no    | yes            |
| 22 May 2023 | yes      | no       |           |             |        |       | yes            |

</details>

</details>

</details>
