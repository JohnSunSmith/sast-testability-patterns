[//]: # (This file is automatically generated. If you wish to make any changes, please use the JSON files and regenerate this file using the tpframework.)

# Callback Functions

Tags: sast, php, php_v7.4.9

Version: v1.0

## Description

[Callbacks](https://www.php.net/manual/en/language.types.callable.php) are defined in PHP.
>>>
Some functions like call_user_func() or usort() accept user-defined callback functions as a parameter. Calls the callback given by the first parameter and passes the remaining parameters as arguments.
Special cases:
*  call_user_func function
*  call_user_func_array function
*  usort function
*  call_user_func with reference
*  call_user_func_array with reference
*  function name as a variable (hard coded and source variable)
*  call_user_func with object
>>>
Note:
Callbacks registered with functions such as call_user_func() and call_user_func_array() will not be called if there is an uncaught exception thrown in a previous callback.

## Overview

| Instances                 | has discovery rule   | discovery method   | rule successfull   |
|---------------------------|----------------------|--------------------|--------------------|
| [1 Instance](#1-instance) | yes                  | joern              | yes                |
| [2 Instance](#2-instance) | yes                  | python             | no                 |
| [3 Instance](#3-instance) | yes                  | joern              | yes                |
| [4 Instance](#4-instance) | yes                  | joern              | yes                |
| [5 Instance](#5-instance) | yes                  | joern              | yes                |

<details markdown="1"open>
<summary>

## 1 Instance
</summary>

The instance uses `call_user_func` with one argument for the function (`$func`) being completely unknown.

### Code

```PHP
<?php
function F($var) {
    return $var;
}

$a = $_GET["p1"]; // source
$func = 'F'
$b = call_user_func($func, $a); // tarpit, $func is completely unknown
echo $b; // sink
```

### Instance Properties

| category   | feature_vs_internal_api   | input_sanitizer   | negative_test_case   | source_and_sink   |
|------------|---------------------------|-------------------|----------------------|-------------------|
| D1         | FEATURE                   | no                | no                   | no                |

<details markdown="1">
<summary>
<b>More</b></summary>

<details markdown="1">
<summary>

### Compile
</summary>

```bash
Cannot load Zend OPcache - it was already loaded
PHP Parse error:  syntax error, unexpected variable "$b" in /.../PHP/80_callback_functions/1_instance_80_callback_functions/1_instance_80_callback_functions.php on line 8
```

</details>

<details markdown="1">
<summary>

### Discovery
</summary>

The rule searches for an `INIT_USER_CALL` with an argument `call_user_func`.

```scala
val x80 = (name, "80_callback_functions_i1", cpg.call(".*INIT_USER_CALL.*").argument.order(1).code("call_user_func.*").location.toJson);
```

| discovery method   | expected accuracy   |
|--------------------|---------------------|
| joern              | Perfect             |

</details>

<details markdown="1"open>
<summary>

### Measurement
</summary>

| Tool        | Comm_1   | Comm_2   | phpSAFE   | Progpilot   | RIPS   | WAP   | Ground Truth   |
|-------------|----------|----------|-----------|-------------|--------|-------|----------------|
| 08 Jun 2021 | no       | yes      | no        | yes         | no     | no    | yes            |
| 22 May 2023 | no       | no       |           |             |        |       | yes            |

</details>

</details>

</details>

<details markdown="1">
<summary>

## 2 Instance
</summary>

This instance uses `call_user_func` on the string 'F' and a value defined by the user.

### Code

```PHP
<?php
function F($var) {
    return $var;
}

$a = $_GET["p1"]; // source
$b = call_user_func('F', $a);
echo $b; // sink
```

### Instance Properties

| category   | feature_vs_internal_api   | input_sanitizer   | negative_test_case   | source_and_sink   |
|------------|---------------------------|-------------------|----------------------|-------------------|
| D2         | FEATURE                   | no                | no                   | no                |

<details markdown="1">
<summary>
<b>More</b></summary>

<details markdown="1">
<summary>

### Compile
</summary>

```bash
$_main:
     ; (lines=9, args=0, vars=2, tmps=5)
     ; (before optimizer)
     ; /.../PHP/80_callback_functions/2_instance_80_callback_functions/2_instance_80_callback_functions.php:1-8
     ; return  [] RANGE[0..0]
0000 T2 = FETCH_R (global) string("_GET")
0001 T3 = FETCH_DIM_R T2 string("p1")
0002 ASSIGN CV0($a) T3
0003 INIT_FCALL 1 96 string("f")
0004 SEND_USER CV0($a) 1
0005 V5 = DO_FCALL
0006 ASSIGN CV1($b) V5
0007 ECHO CV1($b)
0008 RETURN int(1)

F:
     ; (lines=3, args=1, vars=1, tmps=0)
     ; (before optimizer)
     ; /.../PHP/80_callback_functions/2_instance_80_callback_functions/2_instance_80_callback_functions.php:2-4
     ; return  [] RANGE[0..0]
0000 CV0($var) = RECV 1
0001 RETURN CV0($var)
0002 RETURN null
```

</details>

<details markdown="1">
<summary>

### Discovery
</summary>

This instance could profit from source code discovery.

```python
#!/usr/bin/env python3

import subprocess
import sys
from pathlib import Path

def check_string(st):
first_part = ""
if len(st)>0 and ((st[0] == "'" and st[len(st)-1] == "'") or (st[0] == '"' and st[len(st)-1]=='"')):
temp = st[1:]
temp = temp[:-1]
if '"' not in temp and "'" not in temp and '$' not in temp:
first_part = temp
return first_part

if __name__ == "__main__":
project_folder = Path(sys.argv[1])

#print("+++ Apply the transformation on the projects")
dict_projects = {}
dict_process = {}

# Do the changes

#Search for the projects which has call_user_func
#print("+++ Search for call_user_func")
cmd = "grep -Hn -r 'call_user_func' " + str(project_folder)
try:
result = subprocess.check_output(cmd, shell=True)
data = result.decode('utf-8-sig')

counter = 0

resc = {}
dict_call_user_func = {}
dict_line = {}
lines = {}
for line_change in data.split('\n')[:-1]:

if ".php:" not in line_change or ".txt" in line_change:
continue
path_project = line_change.split(".php:")[0]
line = line_change.split(":")[1]
prj = line_change.split("/")[2]
sub_prj = line_change.split("/")[3]
if path_project in lines:
continue
lines[path_project] = 1
if (prj, sub_prj) not in dict_projects:
dict_projects[(prj, sub_prj)] = 1

if line_change in dict_line:
continue

fcode = line_change.split(".php:")[0]+".php"
with open(fcode, 'r', encoding='utf8') as filecode:
try:
datacode = filecode.read()
except:
continue
#fout = open(fcode, "w", encoding='utf8')
dict_line[line_change] = 1
calls = datacode.split("call_user_func")

cnd = True
for call in calls:
if cnd == True:
cnd = False
else:
call = "call_user_func" + call
call_original = call
x = 0
bc = 0
ba = 0
bm = 0
for c in call:
x = x + 1
if c=='(':
bc = bc + 1
if c == ')':
bc = bc - 1
if bc == 0:
break
if c=='[':
ba = ba + 1
if c == ']':
ba = ba - 1
if c=='{':
bm = bm + 1
if c == '}':
bm = bm - 1
if c == ',' and bm == 0 and ba == 0 and bc == 1:
break
x = x - 1
st = call[:x]
cr = 0
if "call_user_func_array" in st:
cr = 1
st = st.replace(" ", "")
st = st.replace("call_user_func_array(", "")
st = st.replace("call_user_func(", "")
first_part = check_string(st)
if first_part == "" and st[:6] == "array(":
temp = st[6:].split(",", 1)
obj = check_string(temp[0])
if obj == "":
obj = temp[0]
method = check_string(temp[1].split(')')[0])
if method != "":
first_part = obj + "->" + method
if first_part != "":
dict_process[(prj, sub_prj)] = 1
dict_call_user_func[(prj, sub_prj)] = 1
call = call[x:]
if cr == 1:
x = 0
for c in call:
if c == ')':
break
if c!=',' and c!=' ' and c!='\n':
break
x = x + 1
if x!=0:
call = call[:x] + "..." + call[x:]
if call[0] == ',':
call = call[1:]
print(path_project + '%' + line)
except:
print('')
```

| discovery method   | expected accuracy   |
|--------------------|---------------------|
| python             | Perfect             |

</details>

<details markdown="1"open>
<summary>

### Measurement
</summary>

| Tool        | Comm_1   | Comm_2   | phpSAFE   | Progpilot   | RIPS   | WAP   | Ground Truth   |
|-------------|----------|----------|-----------|-------------|--------|-------|----------------|
| 08 Jun 2021 | no       | no       | no        | yes         | no     | no    | yes            |
| 22 May 2023 | no       | yes      |           |             |        |       | yes            |
| 25 May 2023 | no       | yes      |           |             |        |       | yes            |

</details>

</details>

</details>

<details markdown="1">
<summary>

## 3 Instance
</summary>

The instance concatenates the name of the function ('F') with the string 'something' before calling `call_user_func` on it, the second argument is a user controlled value.

### Code

```PHP
<?php
function F_something($var) {
    return $var;
}

$a = $_GET["p1"]; // source
$func = "F";
$b = call_user_func($func . "_something", $a);
echo $b; // sink
```

### Instance Properties

| category   | feature_vs_internal_api   | input_sanitizer   | negative_test_case   | source_and_sink   |
|------------|---------------------------|-------------------|----------------------|-------------------|
| D2         | FEATURE                   | no                | no                   | no                |

<details markdown="1">
<summary>
<b>More</b></summary>

<details markdown="1">
<summary>

### Compile
</summary>

```bash
$_main:
     ; (lines=11, args=0, vars=3, tmps=7)
     ; (before optimizer)
     ; /.../PHP/80_callback_functions/3_instance_80_callback_functions/3_instance_80_callback_functions.php:1-9
     ; return  [] RANGE[0..0]
0000 T3 = FETCH_R (global) string("_GET")
0001 T4 = FETCH_DIM_R T3 string("p1")
0002 ASSIGN CV0($a) T4
0003 ASSIGN CV1($func) string("F")
0004 T7 = CONCAT CV1($func) string("_something")
0005 INIT_USER_CALL 1 string("call_user_func") T7
0006 SEND_USER CV0($a) 1
0007 V8 = DO_FCALL
0008 ASSIGN CV2($b) V8
0009 ECHO CV2($b)
0010 RETURN int(1)

F_something:
     ; (lines=3, args=1, vars=1, tmps=0)
     ; (before optimizer)
     ; /.../PHP/80_callback_functions/3_instance_80_callback_functions/3_instance_80_callback_functions.php:2-4
     ; return  [] RANGE[0..0]
0000 CV0($var) = RECV 1
0001 RETURN CV0($var)
0002 RETURN null
```

</details>

<details markdown="1">
<summary>

### Discovery
</summary>

The rule searches for a call of `call_user_func`, that is reachable by a `CONCAT` statement.

```scala
val x80 = (name, "80_callback_functions_i3", cpg.call.code(".*INIT_USER_CALL.*call_user_func.*").reachableBy(cpg.call.code(".*CONCAT.*string.*")).location.toJson);
```

| discovery method   | expected accuracy   |
|--------------------|---------------------|
| joern              | Perfect             |

</details>

<details markdown="1"open>
<summary>

### Measurement
</summary>

| Tool        | Comm_1   | Comm_2   | phpSAFE   | Progpilot   | RIPS   | WAP   | Ground Truth   |
|-------------|----------|----------|-----------|-------------|--------|-------|----------------|
| 08 Jun 2021 | no       | no       | no        | yes         | no     | no    | yes            |
| 22 May 2023 | no       | no       |           |             |        |       | yes            |
| 25 May 2023 | no       | no       |           |             |        |       | yes            |

</details>

</details>

</details>

<details markdown="1">
<summary>

## 4 Instance
</summary>

The instance calls `call_user_func` on the string 'F' and a user defined value.

### Code

```PHP
<?php
function F($var) {
    return $var;
}

$a = $_GET["p1"]; // source
$func = 'F';
$b = call_user_func($func, $a);
echo $b; // sink
```

### Instance Properties

| category   | feature_vs_internal_api   | input_sanitizer   | negative_test_case   | source_and_sink   |
|------------|---------------------------|-------------------|----------------------|-------------------|
| D3         | FEATURE                   | no                | no                   | no                |

<details markdown="1">
<summary>
<b>More</b></summary>

<details markdown="1">
<summary>

### Compile
</summary>

```bash
$_main:
     ; (lines=10, args=0, vars=3, tmps=6)
     ; (before optimizer)
     ; /.../PHP/80_callback_functions/4_instance_80_callback_functions/4_instance_80_callback_functions.php:1-9
     ; return  [] RANGE[0..0]
0000 T3 = FETCH_R (global) string("_GET")
0001 T4 = FETCH_DIM_R T3 string("p1")
0002 ASSIGN CV0($a) T4
0003 ASSIGN CV1($func) string("F")
0004 INIT_USER_CALL 1 string("call_user_func") CV1($func)
0005 SEND_USER CV0($a) 1
0006 V7 = DO_FCALL
0007 ASSIGN CV2($b) V7
0008 ECHO CV2($b)
0009 RETURN int(1)

F:
     ; (lines=3, args=1, vars=1, tmps=0)
     ; (before optimizer)
     ; /.../PHP/80_callback_functions/4_instance_80_callback_functions/4_instance_80_callback_functions.php:2-4
     ; return  [] RANGE[0..0]
0000 CV0($var) = RECV 1
0001 RETURN CV0($var)
0002 RETURN null
```

</details>

<details markdown="1">
<summary>

### Discovery
</summary>

The rule searches for `call_user_func` on opcode level.

```scala
val x80 = (name, "80_callback_functions_i4", cpg.call.code(".*INIT_USER_CALL.*call_user_func.*").reachableBy(cpg.call.code(".*ASSIGN.*string.*")).location.toJson);
```

| discovery method   | expected accuracy   |
|--------------------|---------------------|
| joern              | Perfect             |

</details>

<details markdown="1"open>
<summary>

### Measurement
</summary>

| Tool        | Comm_1   | Comm_2   | phpSAFE   | Progpilot   | RIPS   | WAP   | Ground Truth   |
|-------------|----------|----------|-----------|-------------|--------|-------|----------------|
| 08 Jun 2021 | no       | no       | no        | no          | no     | no    | yes            |
| 22 May 2023 | no       | no       |           |             |        |       | yes            |

</details>

</details>

</details>

<details markdown="1">
<summary>

## 5 Instance
</summary>

Similar to instance 4, but this time, the second argument is wrapped in an array.

### Code

```PHP
<?php
function F($var) {
    return $var;
}

$a = $_GET["p1"]; // source
$func = 'F';
$b = call_user_func_array($func, array($a)); // tarpit, call_user_func_array is another variant
echo $b; // sink
```

### Instance Properties

| category   | feature_vs_internal_api   | input_sanitizer   | negative_test_case   | source_and_sink   |
|------------|---------------------------|-------------------|----------------------|-------------------|
| D4         | FEATURE                   | no                | no                   | no                |

<details markdown="1">
<summary>
<b>More</b></summary>

<details markdown="1">
<summary>

### Compile
</summary>

```bash
$_main:
     ; (lines=12, args=0, vars=3, tmps=7)
     ; (before optimizer)
     ; /.../PHP/80_callback_functions/5_instance_80_callback_functions/5_instance_80_callback_functions.php:1-9
     ; return  [] RANGE[0..0]
0000 T3 = FETCH_R (global) string("_GET")
0001 T4 = FETCH_DIM_R T3 string("p1")
0002 ASSIGN CV0($a) T4
0003 ASSIGN CV1($func) string("F")
0004 INIT_USER_CALL 0 string("call_user_func_array") CV1($func)
0005 T7 = INIT_ARRAY 1 (packed) CV0($a) NEXT
0006 SEND_ARRAY 0 T7
0007 CHECK_UNDEF_ARGS
0008 V8 = DO_FCALL
0009 ASSIGN CV2($b) V8
0010 ECHO CV2($b)
0011 RETURN int(1)

F:
     ; (lines=3, args=1, vars=1, tmps=0)
     ; (before optimizer)
     ; /.../PHP/80_callback_functions/5_instance_80_callback_functions/5_instance_80_callback_functions.php:2-4
     ; return  [] RANGE[0..0]
0000 CV0($var) = RECV 1
0001 RETURN CV0($var)
0002 RETURN null
```

</details>

<details markdown="1">
<summary>

### Discovery
</summary>

The rule searches for `call_user_func` on opcode level.

```scala
val x80 = (name, "80_callback_functions_i5", cpg.call.code(".*INIT_USER_CALL.*call_user_func.*").reachableBy(cpg.call.code(".*ASSIGN.*string.*")).location.toJson);
```

| discovery method   | expected accuracy   |
|--------------------|---------------------|
| joern              | Perfect             |

</details>

<details markdown="1"open>
<summary>

### Measurement
</summary>

| Tool        | Comm_1   | Comm_2   | phpSAFE   | Progpilot   | RIPS   | WAP   | Ground Truth   |
|-------------|----------|----------|-----------|-------------|--------|-------|----------------|
| 08 Jun 2021 | no       | no       | no        | no          | no     | no    | yes            |
| 22 May 2023 | no       | no       |           |             |        |       | yes            |

</details>

</details>

</details>
